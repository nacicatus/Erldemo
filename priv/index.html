<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Erlang Demoscene</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: black;
  }
  canvas {
    display: block;
  }
  #overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-family: sans-serif;
    background: rgba(0,0,0,0.9);
    cursor: pointer;
    z-index: 10;
  }
</style>
</head>
<body>

<div id="overlay">CLICK TO START DEMO</div>
<canvas id="gl"></canvas>

<script>
const canvas = document.getElementById("gl");
const gl = canvas.getContext("webgl");
const overlay = document.getElementById("overlay");

// Receive messages from Erlang
const ws = new WebSocket("ws://localhost:8080/ws");


function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  gl.viewport(0, 0, canvas.width, canvas.height);
}
window.addEventListener("resize", resize);
resize();

// ---------- AUDIO ----------
let audioCtx, osc, gain;

function startAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  osc = audioCtx.createOscillator();
  gain = audioCtx.createGain();

  osc.type = "sawtooth";
  gain.gain.value = Math.exp(-5 * (t % 0.05));

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
}

// ---------- SHADER ----------
const vert = `
attribute vec2 p;
void main() {
  gl_Position = vec4(p,0.0,1.0);
}
`;

const frag = `
precision mediump float;
uniform vec2 res;
uniform float time;

float sphere(vec3 p, float r) {
  return length(p) - r;
}

float map(vec3 p) {
  float d = sphere(p - vec3(sin(time)*1.5, 0.0, 5.0), 1.0);
  d = min(d, sphere(p - vec3(-sin(time*0.7)*1.5, 0.5, 4.0), 0.8));
  return d;
}

vec3 march(vec3 ro, vec3 rd) {
  float t = 0.0;
  for(int i=0;i<64;i++) {
    vec3 p = ro + rd * t;
    float d = map(p);
    if(d < 0.01) {
      return vec3(0.1,0.3,0.7) * (1.0 - t*0.1);
    } 
    t += d;
    if(t > 20.0) break;
  }
  return vec3(0.0);
}

void main() {
  vec2 uv = (gl_FragCoord.xy - res*0.5)/res.x;
  vec3 ro = vec3(0.0,0.0,-2.0);
  vec3 rd = normalize(vec3(uv,1.0));
  vec3 col = march(ro, rd);

  // glow pulse
  col += 0.1 * sin(time*25.0);
  gl_FragColor = vec4(col,1.0);

}
`;

function compile(type, src) {
  const s = gl.createShader(type);
  gl.shaderSource(s, src);
  gl.compileShader(s);
  return s;
}

const prog = gl.createProgram();
gl.attachShader(prog, compile(gl.VERTEX_SHADER, vert));
gl.attachShader(prog, compile(gl.FRAGMENT_SHADER, frag));
gl.linkProgram(prog);
gl.useProgram(prog);

const buf = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, buf);
gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
  -1,-1, 1,-1, -1,1,
  -1,1, 1,-1, 1,1
]), gl.STATIC_DRAW);

const loc = gl.getAttribLocation(prog, "p");
gl.enableVertexAttribArray(loc);
gl.vertexAttribPointer(loc, 2, gl.FLOAT, false, 0, 0);

const timeLoc = gl.getUniformLocation(prog, "time");
const resLoc = gl.getUniformLocation(prog, "res");

// ---------- START ----------
overlay.onclick = async () => {
  overlay.style.display = "none";

  startAudio();
  if (audioCtx.state === "suspended") await audioCtx.resume();

  start();
};

let t = 0;
let beat = 0;

function start() {
  ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  beat = msg.beat;
  currentFrequency = msg.freq;
  osc.frequency.value = 120 + currentFrequency * 200;
  
  gain.gain.value = 0.03 + beat * 0.07;
  

}
  function loop() {
   t = osc.frequency.value;
   
    gl.uniform1f(timeLoc, t + beat * 2.0);
    gl.uniform2f(resLoc, canvas.width, canvas.height);

    gl.drawArrays(gl.TRIANGLES, 0, 6);

    requestAnimationFrame(loop);
  }
  loop();
}
</script>

</body>
</html>