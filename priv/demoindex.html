<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Erlang Raymarch Demo + Sound</title>
<style>
  body { margin: 0; background: black; overflow: hidden; }
  canvas { display: block; }
  #overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-family: sans-serif;
    background: rgba(0,0,0,0.8);
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="overlay">Click to start demo + sound</div>
<canvas id="glcanvas"></canvas>

<script>
const canvas = document.getElementById("glcanvas");
const gl = canvas.getContext("webgl");
const overlay = document.getElementById("overlay");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// ---------- AUDIO ----------
let audioCtx;
let oscillator;
let gainNode;

function startAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  oscillator = audioCtx.createOscillator();
  gainNode = audioCtx.createGain();

  oscillator.type = "sine";
  oscillator.frequency.value = 220;

  gainNode.gain.value = 0.05;

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.start();
}

// ---------- CLICK TO UNLOCK ----------
overlay.addEventListener("click", async () => {
  overlay.style.display = "none";

  startAudio();

  if (audioCtx.state === "suspended") {
    await audioCtx.resume();
  }

  initWebGL();
});

// ---------- SIMPLE WEBGL ----------
function initWebGL() {
  const vertexShaderSrc = `
    attribute vec2 position;
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
    }
  `;

  const fragmentShaderSrc = `
    precision mediump float;
    uniform float time;
    void main() {
      vec2 uv = gl_FragCoord.xy / vec2(${canvas.width}.0, ${canvas.height}.0);
      float color = 0.5 + 0.5 * sin(time + uv.x * 10.0);
      gl_FragColor = vec4(0.0, 0.3, color, 1.0);
    }
  `;

  function compile(type, src) {
    const s = gl.createShader(type);
    gl.shaderSource(s, src);
    gl.compileShader(s);
    return s;
  }

  const program = gl.createProgram();
  gl.attachShader(program, compile(gl.VERTEX_SHADER, vertexShaderSrc));
  gl.attachShader(program, compile(gl.FRAGMENT_SHADER, fragmentShaderSrc));
  gl.linkProgram(program);
  gl.useProgram(program);

  const buffer = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
    -1, -1,  1, -1, -1, 1,
    -1,  1,  1, -1,  1, 1
  ]), gl.STATIC_DRAW);

  const pos = gl.getAttribLocation(program, "position");
  gl.enableVertexAttribArray(pos);
  gl.vertexAttribPointer(pos, 2, gl.FLOAT, false, 0, 0);

  const timeLoc = gl.getUniformLocation(program, "time");

  let t = 0;

  function loop() {
    t += 0.016;

    // SOUND REACTIVITY
    oscillator.frequency.value = 220 + Math.sin(t) * 110;

    gl.uniform1f(timeLoc, t);
    gl.drawArrays(gl.TRIANGLES, 0, 6);

    requestAnimationFrame(loop);
  }

  loop();
}
</script>

</body>
</html>
